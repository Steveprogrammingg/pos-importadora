{% extends "base.html" %}
{% block content %}
<h1>Editar venta • #{{ sale.id }}</h1>

<div class="panel" style="max-width: 1100px;">
  <div class="muted" style="margin-bottom:8px;">
    Esta acción es solo para <b>ADMIN/OWNER</b>. Al cambiar cantidades, el sistema ajusta el inventario automáticamente y registra el movimiento en Kardex.
  </div>

  <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 12px;">
    <div>
      <div class="label">Fecha</div>
      <div class="value">{{ sale.created_at.strftime("%Y-%m-%d %H:%M") }}</div>
    </div>
    <div>
      <div class="label">Sucursal</div>
      <div class="value">{{ sale.branch_id }}</div>
    </div>
    <div>
      <div class="label">Cliente</div>
      <div class="value">{% if client %}{{ client.name }}{% else %}—{% endif %}</div>
    </div>
  </div>

  <form method="post" action="{{ url_for('reports.sale_edit_submit', sale_id=sale.id) }}" style="margin-top: 14px;">

    <div class="grid" style="grid-template-columns: 1fr 2fr; gap: 12px; align-items:end;">
      <div>
        <label>Método de pago</label>
        <select name="payment_method" required>
          <option value="cash" {% if (sale.payment_method or 'cash') == 'cash' %}selected{% endif %}>Efectivo</option>
          <option value="transfer" {% if (sale.payment_method or '') == 'transfer' %}selected{% endif %}>Transferencia</option>
        </select>
        <p class="muted" style="margin-top:6px;">Puedes corregir el método de pago sin afectar inventario.</p>
      </div>
      <div>
        <a class="btn secondary" href="{{ url_for('reports.sales_list') }}">Volver a reportes</a>
        <a class="btn secondary" href="{{ url_for('pos.ticket', sale_id=sale.id) }}">Ver ticket</a>
      </div>
    </div>

    <h2 style="margin-top: 16px;">Productos de la venta</h2>

    <table class="table" style="margin-top: 10px;">
      <thead>
        <tr>
          <th>Producto</th>
          <th style="width:120px;">Cantidad</th>
          <th style="width:140px;">Precio unit.</th>
          <th style="width:120px; text-align:right;">Subtotal</th>
          <th style="width:110px; text-align:center;">Quitar</th>
        </tr>
      </thead>
      <tbody>
        {% for it in sale.items %}
        <tr>
          <td>
            <b>{{ it.product.name }}</b>
            <div class="muted">SKU: {{ it.product.sku or '—' }} • Barcode: {{ it.product.barcode or '—' }}</div>
          </td>
          <td>
            <input type="number" step="0.001" min="0" name="qty_{{ it.id }}" value="{{ it.qty }}" style="width:110px;">
          </td>
          <td>
            <input type="number" step="0.01" min="0" name="price_{{ it.id }}" value="{{ it.unit_price }}" style="width:130px;">
          </td>
          <td style="text-align:right;">{{ "%.2f"|format(it.subtotal) }}</td>
          <td style="text-align:center;">
            <label style="display:inline-flex; gap:6px; align-items:center; justify-content:center;">
              <input type="checkbox" name="remove_{{ it.id }}" value="1">
              <span class="muted">Quitar</span>
            </label>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="panel" style="margin-top: 12px;">
      <h3 style="margin:0 0 8px 0;">Agregar producto</h3>
      <div class="grid" style="grid-template-columns: 3fr 1fr 1fr; gap: 10px; align-items:end;">
        <div>
          <label>Producto</label>
          <select name="new_product_id">
            <option value="">— Seleccionar —</option>
            {% for p in products %}
              <option value="{{ p.id }}">{{ p.name }}{% if p.sku %} • {{ p.sku }}{% endif %}{% if p.barcode %} • {{ p.barcode }}{% endif %}</option>
            {% endfor %}
          </select>
          <p class="muted" style="margin-top:6px;">Tip: escribe y usa la búsqueda del navegador dentro del select (Ctrl+F) si tienes muchos productos.</p>
        </div>
        <div>
          <label>Cantidad</label>
          <input type="number" step="0.001" min="0" name="new_qty" placeholder="0.000">
        </div>
        <div>
          <label>Precio unit. (opcional)</label>
          <input type="number" step="0.01" min="0" name="new_price" placeholder="(auto)">
        </div>
      </div>
      <p class="muted" style="margin-top:8px;">
        Si dejas el precio en blanco, se usará el precio según el tipo de la venta (<b>{{ sale.price_mode }}</b>).
      </p>
    </div>

    <div style="margin-top: 14px; display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" type="submit">Guardar cambios</button>
      <a class="btn secondary" href="{{ url_for('reports.sales_list') }}">Cancelar</a>
    </div>

  </form>
</div>

{% endblock %}
